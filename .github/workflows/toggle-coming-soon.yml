name: ğŸš§ Toggle Coming Soon Page

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'AÃ§Ã£o a executar'
        required: true
        default: 'enable'
        type: choice
        options:
        - enable
        - disable
      message:
        description: 'Mensagem personalizada (opcional)'
        required: false
        default: 'Estamos chegando em breve! ğŸ¾'

jobs:
  toggle-coming-soon:
    name: ğŸ”„ ${{ github.event.inputs.action == 'enable' && 'Ativar' || 'Desativar' }} PÃ¡gina "Em Breve"
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ¨ Customize Coming Soon Message
      if: github.event.inputs.action == 'enable' && github.event.inputs.message != ''
      run: |
        # Personalizar mensagem na pÃ¡gina coming-soon.html
        sed -i 's/Estamos chegando em breve! ğŸ¾/${{ github.event.inputs.message }}/g' public/coming-soon.html
        echo "âœ… Mensagem personalizada aplicada: ${{ github.event.inputs.message }}"
      
    - name: ğŸš§ Enable Coming Soon Mode
      if: github.event.inputs.action == 'enable'
      run: |
        echo "ğŸš€ Ativando modo 'Em Breve'..."
        
        # Fazer backup do .htaccess atual se existir
        if [ -f "dist/.htaccess" ]; then
          cp dist/.htaccess .htaccess-backup
          echo "ğŸ’¾ Backup do .htaccess criado"
        fi
        
        # Criar diretÃ³rio dist se nÃ£o existir
        mkdir -p dist
        
        # Copiar .htaccess do coming-soon
        cp .htaccess-coming-soon dist/.htaccess
        echo "âœ… .htaccess do modo 'Em Breve' ativado"
        
        # Copiar pÃ¡gina coming-soon para dist
        mkdir -p dist/public
        cp public/coming-soon.html dist/public/
        echo "âœ… PÃ¡gina 'Em Breve' copiada"
        
        # Criar arquivo de status
        echo "COMING_SOON_ACTIVE=true" > dist/.coming-soon-status
        echo "ACTIVATED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> dist/.coming-soon-status
        echo "ACTIVATED_BY=${{ github.actor }}" >> dist/.coming-soon-status
        echo "COMMIT_SHA=${{ github.sha }}" >> dist/.coming-soon-status
        
        echo "ğŸ¯ Modo 'Em Breve' ativado com sucesso!"
        
    - name: ğŸ”“ Disable Coming Soon Mode
      if: github.event.inputs.action == 'disable'
      run: |
        echo "ğŸ”“ Desativando modo 'Em Breve'..."
        
        # Build da aplicaÃ§Ã£o normal
        npm run build
        
        # Restaurar .htaccess original se existir backup
        if [ -f ".htaccess-backup" ]; then
          cp .htaccess-backup dist/.htaccess
          echo "âœ… .htaccess original restaurado"
        else
          # Gerar .htaccess padrÃ£o da aplicaÃ§Ã£o
          cat > dist/.htaccess << 'EOF'
        # PetShop Romeo & Julieta - Hostinger Configuration
        
        # Enable HTTPS redirect
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
        
        # Handle React Router (SPA)
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
        
        # Security Headers
        <IfModule mod_headers.c>
            Header always set X-Content-Type-Options nosniff
            Header always set X-Frame-Options DENY
            Header always set X-XSS-Protection "1; mode=block"
            Header always set Referrer-Policy "strict-origin-when-cross-origin"
        </IfModule>
        
        # Compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/javascript
        </IfModule>
        
        # Cache Control
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
        </IfModule>
        EOF
          echo "âœ… .htaccess padrÃ£o gerado"
        fi
        
        # Remover arquivos do modo coming-soon
        rm -f dist/public/coming-soon.html
        rm -f dist/.coming-soon-status
        
        echo "ğŸ¯ Modo 'Em Breve' desativado com sucesso!"
        
    - name: ğŸ—ï¸ Build Application (for disable mode)
      if: github.event.inputs.action == 'disable'
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
      run: |
        echo "ğŸ—ï¸ Fazendo build da aplicaÃ§Ã£o completa..."
        npm run build
        
    - name: ğŸ“Š Deploy Status Check
      run: |
        echo "ğŸ“‹ Status do Deploy:"
        echo "   - AÃ§Ã£o: ${{ github.event.inputs.action }}"
        echo "   - UsuÃ¡rio: ${{ github.actor }}"
        echo "   - Commit: ${{ github.sha }}"
        echo "   - Branch: ${{ github.ref_name }}"
        echo "   - Data: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        
        if [ "${{ github.event.inputs.action }}" = "enable" ]; then
          echo "   - PÃ¡gina 'Em Breve': âœ… ATIVA"
          echo "   - Mensagem: ${{ github.event.inputs.message || 'Estamos chegando em breve! ğŸ¾' }}"
        else
          echo "   - PÃ¡gina 'Em Breve': âŒ INATIVA"
          echo "   - AplicaÃ§Ã£o: âœ… NORMAL"
        fi
        
        echo ""
        echo "ğŸ“ Arquivos no dist/:"
        ls -la dist/ || echo "DiretÃ³rio dist nÃ£o encontrado"
        
    - name: ğŸš€ Deploy to Hostinger via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: ${{ secrets.FTP_PATH }}/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.env*
          **/.coming-soon-status
          
    - name: ğŸ‰ Success Notification
      run: |
        if [ "${{ github.event.inputs.action }}" = "enable" ]; then
          echo "ğŸš§ âœ… PÃ¡gina 'Em Breve' ATIVADA com sucesso!"
          echo "ğŸŒ Seu site agora mostra: ${{ github.event.inputs.message || 'Estamos chegando em breve! ğŸ¾' }}"
          echo "ğŸ”§ Para desativar, execute este workflow novamente com action='disable'"
        else
          echo "ğŸš€ âœ… PÃ¡gina 'Em Breve' DESATIVADA com sucesso!"
          echo "ğŸŒ Seu site estÃ¡ funcionando normalmente"
          echo "ğŸ”§ Para ativar novamente, execute este workflow com action='enable'"
        fi
        
        echo ""
        echo "ğŸ“… Deploy realizado em: $(date)"
        echo "ğŸ‘¤ Por: ${{ github.actor }}"
        echo "ğŸ”— Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"